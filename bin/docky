#!/bin/bash
PLATFORMS=("woocommerce" "magento" "eccube")
PACKAGE_LOCATION="https://github.com/guzzilar"

version_folder=".version"
execute_command=""
build_folder=""
build_platform=""
build_source=""
build_version="latest"

##
# Show the usage of Docky.
##
doc() {
    echo -e ''
    echo -e 'usage: docky build [--platform=<name>] [--target=<version>]'
    echo -e ''
    echo -e '--platform\tSpecify the target platform that you want to build'
    echo -e '--target\tSpecify the target version that you want to build'
    echo -e ''
}

##
# Check if Docky supports a build target platform.
#
hasPlatform() {
    local platform

    for platform in ${PLATFORMS[@]}; do
        [[ $platform == $1 ]] && {
            return 0
        }
    done

    return 1
}

##
# Preparation
#
initialize() {
    echo "###################################################"
    echo "Docky: Checking the container version.."
    if [ ! -d $version_folder ]; then
        mkdir -p $version_folder
        echo " > Created a new folder, $version_folder."
    fi

    local container_version=$(curl -s https://api.github.com/repos/guzzilar/docker-woocommerce/git/refs/heads/master | jq '.object.sha' | sed -e 's/^"//' -e 's/"$//')

    if [ ! -f "$version_folder/docker-$build_platform.$container_version" ]; then
        rm $version_folder/docker-$build_platform.*
        touch $version_folder/docker-$build_platform.$container_version
        echo " > Found a new version of docker-$build_platform (commit: $container_version)"
        echo " > Cached: $version_folder/docker-$build_platform.$container_version"
    fi

    ## TODO : Will continue later...

    build_folder="deploy/$build_platform"
    local package_location="$PACKAGE_LOCATION/docker-$build_platform/archive/master.zip"

    echo "***************************************"
    echo "Docky: Preparing docker..."

    if [ ! -d $build_folder ]; then
        echo "Docky: Build directory: $build_folder "
        mkdir -p $build_folder
    fi

    [[ ! -d $build_folder/src && ! -f $build_folder/tmp/docker-$build_platform.zip ]] && {
        # 1. Download.
        mkdir $build_folder/tmp
        echo "Docky: Downloading a Docker package from $package_location."
        echo "Docky: ================================================================================"
        wget -O $build_folder/tmp/docker-$build_platform.zip $package_location

        # 2. Unzip
        echo "Docky: ================================================================================"
        unzip $build_folder/tmp/docker-$build_platform.zip -d $build_folder/tmp/
        echo "Docky: Moving file to $build_folder."
        mv $build_folder/tmp/docker-$build_platform-master/* $build_folder

        # 3. Remove.
        echo "Docky: ================================================================================"
        echo "Docky: Removing $build_folder/tmp directory."
        rm -R $build_folder/tmp
    }
}

##
# Boot up a container!
#
up() {
    initialize

    echo "Docky: Booting up the docker!"
    echo "Docky: ================================================================================"
    $build_folder/bin/start $build_version --build --source=$build_source
}

##
# Build it!
#
build() {
    initialize

    echo "Docky: Building the docker!"
    echo "Docky: ================================================================================"
    $build_folder/bin/start $build_version --re-build --source=$build_source
}

# $1 cannot be empty.
# And the first argument must be "build".
execute_command=$1
[[ -z $execute_command || $execute_command != "up" && $execute_command != "build" ]] && {
    doc
    exit
}

# Remove "execute command" from arguments.
shift

# Reading arguments.
while [[ $# -gt 0 ]]; do
    case "$1" in
        --version=*)
            build_version="${1#*=}"
            shift
            ;;

        --source=*)
            build_source="${1#*=}"
            shift
            ;;

        *)
            [[ -z $build_platform ]] && {
                OIFS=$IFS
                IFS=":"
                target=($1)

                if ! hasPlatform ${target[0]}; then
                    echo "error: platform \"$1\" did not match any platform(s) Docky supported."
                    exit
                fi

                build_platform=${target[0]}
                build_version=$([[ ! -z ${target[1]} ]] && echo ${target[1]} || echo "latest")

                IFS=$OIFS
            }
            shift
            ;;
    esac
done

[[ ! -z $build_platform ]] && {
    $execute_command
}
